// ==UserScript==
// @name        UC Tournament View
// @version     0.1.0
// @author      JoanJuan10
// @description Plugin para UnderScript que mejora la vista de espectador en Undercards.net con plantillas modernas
// @homepage    https://github.com/JoanJuan10/UC_TournamentView
// @match       https://*.undercards.net/*
// @namespace   https://uc.feildmaster.com/
// @exclude     https://*.undercards.net/*/*
// @updateURL   https://github.com/JoanJuan10/UC_TournamentView/releases/latest/download/tournamentview.meta.js
// @downloadURL https://github.com/JoanJuan10/UC_TournamentView/releases/latest/download/tournamentview.user.js
// @require     https://raw.githubusercontent.com/UCProjects/UnderScript/master/src/checkerV2.js
// @grant       none
// ==/UserScript==

!function(e){var n={};function t(o){if(n[o])return n[o].exports;var a=n[o]={i:o,l:!1,exports:{}};return e[o].call(a.exports,a,a.exports,t),a.l=!0,a.exports}t.m=e,t.c=n,t.d=function(e,n,o){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:o})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(t.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var a in e)t.d(o,a,function(n){return e[n]}.bind(null,a));return o},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t(t.s=0)}([function(e,n){const t=window.underscript,o=t.plugin("TournamentView",GM_info.version);const a=new class{constructor(){this.reset()}reset(){this.isActive=!1,this.isSpectate=!1,this.player={id:null,username:"",hp:0,maxHp:0,gold:0,soul:"",soulLives:0,artifacts:[],handCount:0,deckCount:0,boardCount:0,graveyardCount:0},this.opponent={id:null,username:"",hp:0,maxHp:0,gold:0,soul:"",soulLives:0,artifacts:[],handCount:0,deckCount:0,boardCount:0,graveyardCount:0},this.turn=0,this.currentPlayer=null,this.gameResult=null,this.actionLog=[],this.maxLogEntries=50}updatePlayer(e){void 0!==e.hp&&(this.player.hp=e.hp),void 0!==e.maxHp&&(this.player.maxHp=e.maxHp),void 0!==e.gold&&(this.player.gold=e.gold),void 0!==e.soul&&(this.player.soul=e.soul),void 0!==e.soulLives&&(this.player.soulLives=e.soulLives),void 0!==e.artifacts&&(this.player.artifacts=e.artifacts),void 0!==e.handCount&&(this.player.handCount=e.handCount),void 0!==e.deckCount&&(this.player.deckCount=e.deckCount),void 0!==e.boardCount&&(this.player.boardCount=e.boardCount),void 0!==e.graveyardCount&&(this.player.graveyardCount=e.graveyardCount)}updateOpponent(e){void 0!==e.hp&&(this.opponent.hp=e.hp),void 0!==e.maxHp&&(this.opponent.maxHp=e.maxHp),void 0!==e.gold&&(this.opponent.gold=e.gold),void 0!==e.soul&&(this.opponent.soul=e.soul),void 0!==e.soulLives&&(this.opponent.soulLives=e.soulLives),void 0!==e.artifacts&&(this.opponent.artifacts=e.artifacts),void 0!==e.handCount&&(this.opponent.handCount=e.handCount),void 0!==e.deckCount&&(this.opponent.deckCount=e.deckCount),void 0!==e.boardCount&&(this.opponent.boardCount=e.boardCount),void 0!==e.graveyardCount&&(this.opponent.graveyardCount=e.graveyardCount)}getState(){return{isActive:this.isActive,isSpectate:this.isSpectate,player:{...this.player},opponent:{...this.opponent},turn:this.turn,currentPlayer:this.currentPlayer,gameResult:this.gameResult}}addAction(e,n,t,o={}){this.actionLog.unshift({timestamp:Date.now(),turn:this.turn,type:e,player:n,message:t,data:o}),this.actionLog.length>this.maxLogEntries&&this.actionLog.pop()}};const r=new class{constructor(){this.currentTemplate=null,this.cssElement=null}loadDefaultTemplate(){this.currentTemplate={metadata:{name:"Basic",version:"1.0.0",author:"TournamentView",description:"Plantilla bÃ¡sica de Tournament View"},config:{enableAnimations:!0,showPlayerStats:!0,showActionLog:!1,compactMode:!1},variables:{primaryColor:"#667eea",secondaryColor:"#764ba2",accentColor:"#f093fb",backgroundColor:"#0f0f23",textColor:"#ffffff"}}}injectCSS(){this.currentTemplate||this.loadDefaultTemplate();const e=`\n${this.generateCSSVariables()}\n${this.getBaseCSS()}\n`;this.cssElement?this.cssElement.textContent=e:this.cssElement=o.addStyle(e),console.log("[TournamentView] CSS inyectado")}removeCSS(){this.cssElement&&this.cssElement.parentNode&&this.cssElement.remove(),this.cssElement=null,console.log("[TournamentView] CSS removido")}generateCSSVariables(){const e=this.currentTemplate.variables||{};let n=":root {\n";for(const[t,o]of Object.entries(e)){n+=`  --tv-${t.replace(/([A-Z])/g,"-$1").toLowerCase()}: ${o};\n`}return n+="}\n",n}getBaseCSS(){return"\n/* Tournament View Base Styles */\n#uc-tournament-view {\n    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n    color: var(--tv-text-color, #ffffff);\n    position: fixed;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    z-index: 9999;\n    pointer-events: none;\n}\n\n#uc-tournament-view * {\n    box-sizing: border-box;\n}\n\n/* Header Bar */\n.tv-header {\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    height: 80px;\n    background: linear-gradient(135deg, var(--tv-primary-color) 0%, var(--tv-secondary-color) 100%);\n    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: 0 1.5rem;\n    pointer-events: auto;\n}\n\n.tv-player-info {\n    display: flex;\n    align-items: center;\n    gap: 1rem;\n    flex: 1;\n    position: relative;\n    transition: all 0.3s ease;\n}\n\n.tv-player-info.active-turn::before {\n    content: '';\n    position: absolute;\n    top: -8px;\n    left: -8px;\n    right: -8px;\n    bottom: -8px;\n    border: 3px solid #fbbf24;\n    border-radius: 12px;\n    animation: pulse-border 2s infinite;\n    pointer-events: none;\n}\n\n@keyframes pulse-border {\n    0%, 100% {\n        opacity: 1;\n        transform: scale(1);\n    }\n    50% {\n        opacity: 0.7;\n        transform: scale(1.02);\n    }\n}\n\n@keyframes shake {\n    0%, 100% { transform: translateX(0); }\n    25% { transform: translateX(-4px); }\n    50% { transform: translateX(4px); }\n    75% { transform: translateX(-4px); }\n}\n\n@keyframes slideInRight {\n    from {\n        right: -350px;\n        opacity: 0;\n    }\n    to {\n        right: 20px;\n        opacity: 1;\n    }\n}\n\n@keyframes slideOutRight {\n    from {\n        right: 20px;\n        opacity: 1;\n    }\n    to {\n        right: -350px;\n        opacity: 0;\n    }\n}\n\n@keyframes bounce {\n    0%, 100% { transform: translateY(0); }\n    50% { transform: translateY(-5px); }\n}\n\n@keyframes glow {\n    0%, 100% {\n        box-shadow: 0 0 5px currentColor;\n    }\n    50% {\n        box-shadow: 0 0 20px currentColor, 0 0 30px currentColor;\n    }\n}\n\n@keyframes artifactPulse {\n    0%, 100% {\n        transform: scale(1);\n        filter: drop-shadow(0 0 5px #fbbf24);\n    }\n    50% {\n        transform: scale(1.1);\n        filter: drop-shadow(0 0 15px #fbbf24) drop-shadow(0 0 25px #fbbf24);\n    }\n}\n\n.tv-player-name {\n    font-size: 1.5rem;\n    font-weight: bold;\n    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);\n    letter-spacing: 0.5px;\n}\n\n.tv-player-hp {\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n    background: rgba(0, 0, 0, 0.3);\n    padding: 0.5rem 1rem;\n    border-radius: 8px;\n    backdrop-filter: blur(10px);\n}\n\n.tv-hp-bar {\n    width: 120px;\n    height: 12px;\n    background: rgba(0, 0, 0, 0.5);\n    border-radius: 6px;\n    overflow: hidden;\n    position: relative;\n}\n\n.tv-hp-fill {\n    height: 100%;\n    background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #10b981 100%);\n    transition: width 0.3s ease;\n    box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);\n}\n\n.tv-hp-fill.hp-damage {\n    animation: shake 0.3s ease;\n    box-shadow: 0 0 20px rgba(239, 68, 68, 0.8);\n}\n\n.tv-hp-fill.hp-heal {\n    animation: bounce 0.5s ease;\n    box-shadow: 0 0 20px rgba(16, 185, 129, 0.8);\n}\n\n.tv-soul-image.soul-glow {\n    animation: glow 0.5s ease 2;\n    color: #3b82f6;\n}\n\n.tv-artifact-image.artifact-glow {\n    animation: artifactPulse 0.6s ease 2;\n}\n\n.tv-hp-text {\n    font-size: 0.875rem;\n    font-weight: bold;\n    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);\n    min-width: 50px;\n    text-align: center;\n}\n\n.tv-player-gold {\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n    background: rgba(0, 0, 0, 0.3);\n    padding: 0.5rem 1rem;\n    border-radius: 8px;\n    backdrop-filter: blur(10px);\n}\n\n.tv-gold-text {\n    font-size: 1rem;\n    font-weight: bold;\n    color: var(--tv-accent-color, #f093fb);\n    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);\n}\n\n.tv-player-soul {\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n    background: rgba(0, 0, 0, 0.3);\n    padding: 0.5rem 1rem;\n    border-radius: 8px;\n    backdrop-filter: blur(10px);\n}\n\n.tv-soul-text {\n    font-size: 0.875rem;\n    font-weight: bold;\n    color: #fbbf24;\n    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);\n    text-transform: uppercase;\n}\n\n.tv-player-artifacts {\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n    background: rgba(0, 0, 0, 0.3);\n    padding: 0.5rem 1rem;\n    border-radius: 8px;\n    backdrop-filter: blur(10px);\n    max-width: 200px;\n}\n\n.tv-artifacts-text {\n    font-size: 0.75rem;\n    font-weight: bold;\n    color: #a78bfa;\n    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n}\n\n.tv-player-cards {\n    display: flex;\n    align-items: center;\n    gap: 0.75rem;\n    background: rgba(0, 0, 0, 0.3);\n    padding: 0.5rem 1rem;\n    border-radius: 8px;\n    backdrop-filter: blur(10px);\n}\n\n.tv-card-counter {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    gap: 0.25rem;\n}\n\n.tv-card-counter-label {\n    font-size: 0.625rem;\n    color: #a0a0b0;\n    text-transform: uppercase;\n    letter-spacing: 0.5px;\n}\n\n.tv-card-counter-value {\n    font-size: 1rem;\n    font-weight: bold;\n    color: #ffffff;\n    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);\n}\n\n/* Center Info */\n.tv-center-info {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    gap: 0.5rem;\n}\n\n.tv-turn-indicator {\n    background: rgba(0, 0, 0, 0.4);\n    padding: 0.5rem 1.5rem;\n    border-radius: 8px;\n    backdrop-filter: blur(10px);\n    text-align: center;\n}\n\n.tv-turn-label {\n    font-size: 0.875rem;\n    color: #a0a0b0;\n    text-transform: uppercase;\n    letter-spacing: 1px;\n}\n\n.tv-turn-number {\n    font-size: 1.5rem;\n    font-weight: bold;\n    color: var(--tv-accent-color, #f093fb);\n    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);\n}\n\n.tv-turn-timer {\n    font-size: 0.875rem;\n    color: #fbbf24;\n    font-weight: bold;\n    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);\n    min-width: 30px;\n    text-align: center;\n}\n\n.tv-turn-timer.low {\n    color: #ef4444;\n    animation: pulse 1s infinite;\n}\n\n@keyframes pulse {\n    0%, 100% { opacity: 1; }\n    50% { opacity: 0.5; }\n}\n\n/* Opponent Info */\n.tv-opponent-info {\n    display: flex;\n    align-items: center;\n    gap: 1rem;\n    flex: 1;\n    justify-content: flex-end;\n    flex-direction: row-reverse;\n    position: relative;\n    transition: all 0.3s ease;\n}\n\n.tv-opponent-info.active-turn::before {\n    content: '';\n    position: absolute;\n    top: -8px;\n    left: -8px;\n    right: -8px;\n    bottom: -8px;\n    border: 3px solid #fbbf24;\n    border-radius: 12px;\n    animation: pulse-border 2s infinite;\n    pointer-events: none;\n}\n\n/* Result Overlay */\n.tv-result-overlay {\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background: rgba(0, 0, 0, 0.8);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    backdrop-filter: blur(5px);\n    pointer-events: auto;\n    animation: fadeIn 0.5s ease;\n}\n\n@keyframes fadeIn {\n    from { opacity: 0; }\n    to { opacity: 1; }\n}\n\n.tv-result-container {\n    background: linear-gradient(135deg, #1a1a2e 0%, var(--tv-background-color) 100%);\n    border: 2px solid #2a2a3e;\n    border-radius: 8px;\n    padding: 2rem 3rem;\n    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);\n    text-align: center;\n    animation: scaleIn 0.5s ease;\n    min-width: 400px;\n}\n\n@keyframes scaleIn {\n    from {\n        opacity: 0;\n        transform: scale(0.8);\n    }\n    to {\n        opacity: 1;\n        transform: scale(1);\n    }\n}\n\n.tv-result-title {\n    font-size: 3rem;\n    font-weight: bold;\n    margin-bottom: 1.5rem;\n    text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);\n}\n\n.tv-result-title.victory {\n    color: #10b981;\n    text-shadow: 0 0 20px rgba(16, 185, 129, 0.5);\n}\n\n.tv-result-title.defeat {\n    color: #ef4444;\n    text-shadow: 0 0 20px rgba(239, 68, 68, 0.5);\n}\n\n.tv-result-stats {\n    display: flex;\n    flex-direction: column;\n    gap: 1rem;\n    margin-top: 1.5rem;\n}\n\n.tv-result-stat {\n    display: flex;\n    justify-content: space-between;\n    padding: 0.5rem 1rem;\n    background: rgba(0, 0, 0, 0.3);\n    border-radius: 4px;\n}\n\n.tv-result-stat-label {\n    color: #a0a0b0;\n}\n\n.tv-result-stat-value {\n    color: var(--tv-text-color, #ffffff);\n    font-weight: bold;\n}\n\n/* Notificaciones Flotantes */\n.tv-notification {\n    position: fixed;\n    top: 90px;\n    right: 20px;\n    padding: 0.75rem 1.25rem;\n    border-radius: 8px;\n    color: white;\n    font-weight: 500;\n    font-size: 0.9rem;\n    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\n    z-index: 10001;\n    animation: slideInRight 0.3s ease forwards;\n    margin-bottom: 10px;\n    backdrop-filter: blur(10px);\n    max-width: 300px;\n    word-wrap: break-word;\n}\n\n.tv-notification.hiding {\n    animation: slideOutRight 0.3s ease forwards;\n}\n\n.tv-notification-info {\n    background: linear-gradient(135deg, rgba(59, 130, 246, 0.9), rgba(37, 99, 235, 0.9));\n}\n\n.tv-notification-card {\n    background: linear-gradient(135deg, rgba(16, 185, 129, 0.9), rgba(5, 150, 105, 0.9));\n}\n\n.tv-notification-spell {\n    background: linear-gradient(135deg, rgba(139, 92, 246, 0.9), rgba(109, 40, 217, 0.9));\n}\n\n.tv-notification-damage {\n    background: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(220, 38, 38, 0.9));\n}\n\n.tv-notification-heal {\n    background: linear-gradient(135deg, rgba(16, 185, 129, 0.9), rgba(5, 150, 105, 0.9));\n}\n\n.tv-notification-artifact {\n    background: linear-gradient(135deg, rgba(251, 191, 36, 0.9), rgba(245, 158, 11, 0.9));\n}\n\n/* Panel de Historial */\n.tv-action-log {\n    position: fixed;\n    top: 90px;\n    right: 0;\n    width: 350px;\n    max-height: calc(100vh - 100px);\n    background: linear-gradient(135deg, rgba(15, 15, 35, 0.95), rgba(30, 30, 60, 0.95));\n    backdrop-filter: blur(10px);\n    border-radius: 12px 0 0 12px;\n    box-shadow: -4px 0 20px rgba(0, 0, 0, 0.5);\n    z-index: 9999;\n    transition: transform 0.3s ease;\n    display: flex;\n    flex-direction: column;\n}\n\n.tv-action-log.collapsed {\n    transform: translateX(350px);\n}\n\n.tv-log-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    padding: 1rem;\n    background: linear-gradient(135deg, var(--tv-primary-color), var(--tv-secondary-color));\n    border-radius: 12px 0 0 0;\n    color: white;\n    font-weight: bold;\n    font-size: 1rem;\n}\n\n.tv-log-toggle {\n    background: rgba(255, 255, 255, 0.2);\n    border: none;\n    color: white;\n    width: 28px;\n    height: 28px;\n    border-radius: 50%;\n    cursor: pointer;\n    font-size: 1.2rem;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    transition: all 0.2s ease;\n}\n\n.tv-log-toggle:hover {\n    background: rgba(255, 255, 255, 0.3);\n    transform: scale(1.1);\n}\n\n.tv-log-content {\n    flex: 1;\n    overflow-y: auto;\n    padding: 0.5rem;\n}\n\n.tv-log-content::-webkit-scrollbar {\n    width: 6px;\n}\n\n.tv-log-content::-webkit-scrollbar-track {\n    background: rgba(0, 0, 0, 0.2);\n    border-radius: 3px;\n}\n\n.tv-log-content::-webkit-scrollbar-thumb {\n    background: var(--tv-accent-color);\n    border-radius: 3px;\n}\n\n.tv-log-entry {\n    padding: 0.5rem 0.75rem;\n    margin-bottom: 0.5rem;\n    border-radius: 6px;\n    background: rgba(255, 255, 255, 0.05);\n    border-left: 3px solid var(--tv-accent-color);\n    font-size: 0.85rem;\n    color: rgba(255, 255, 255, 0.9);\n    animation: fadeIn 0.3s ease;\n}\n\n.tv-log-entry-turn {\n    border-left-color: #fbbf24;\n}\n\n.tv-log-entry-hp {\n    border-left-color: #ef4444;\n}\n\n.tv-log-entry-card {\n    border-left-color: #10b981;\n}\n\n.tv-log-entry-spell {\n    border-left-color: #8b5cf6;\n}\n\n.tv-log-entry-artifact {\n    border-left-color: #fbbf24;\n}\n\n.tv-log-entry-soul {\n    border-left-color: #3b82f6;\n}\n\n.tv-log-turn {\n    color: #fbbf24;\n    font-weight: bold;\n    font-size: 0.75rem;\n}\n\n.tv-log-player {\n    color: var(--tv-accent-color);\n    font-weight: 600;\n}\n\n.tv-log-message {\n    margin-top: 0.25rem;\n}\n\n/* BotÃ³n Toggle Flotante para Historial */\n.tv-log-float-toggle {\n    position: fixed;\n    top: 100px;\n    right: 10px;\n    width: 40px;\n    height: 40px;\n    background: linear-gradient(135deg, var(--tv-primary-color), var(--tv-secondary-color));\n    border: none;\n    border-radius: 50%;\n    color: white;\n    font-size: 1.2rem;\n    cursor: pointer;\n    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\n    z-index: 10000;\n    transition: all 0.3s ease;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n}\n\n.tv-log-float-toggle:hover {\n    transform: scale(1.1);\n    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);\n}\n\n/* Responsive Design */\n@media (max-width: 1280px) {\n    .tv-header {\n        height: 60px;\n        padding: 0 1rem;\n    }\n    \n    .tv-player-name {\n        font-size: 1.2rem;\n    }\n    \n    .tv-hp-bar {\n        width: 100px;\n    }\n    \n    .tv-card-counter-label {\n        font-size: 0.5rem;\n    }\n    \n    .tv-artifact-image {\n        width: 30px;\n        height: 30px;\n    }\n}\n\n@media (max-width: 768px) {\n    .tv-header {\n        height: auto;\n        flex-direction: column;\n        padding: 0.5rem;\n        gap: 0.5rem;\n    }\n    \n    .tv-player-info,\n    .tv-opponent-info {\n        width: 100%;\n        justify-content: space-between;\n    }\n    \n    .tv-turn-info {\n        width: 100%;\n        order: -1;\n    }\n    \n    .tv-result-container {\n        min-width: 90vw;\n        padding: 1.5rem;\n    }\n    \n    .tv-action-log {\n        width: 100%;\n        max-height: 50vh;\n        border-radius: 12px 12px 0 0;\n        top: auto;\n        bottom: 0;\n    }\n    \n    .tv-action-log.collapsed {\n        transform: translateY(100%);\n    }\n    \n    .tv-notification {\n        max-width: calc(100vw - 40px);\n        right: 10px;\n    }\n}\n\n@media (max-width: 480px) {\n    .tv-player-name {\n        font-size: 1rem;\n    }\n    \n    .tv-hp-bar {\n        width: 80px;\n        height: 10px;\n    }\n    \n    .tv-card-counters {\n        gap: 0.25rem;\n    }\n    \n    .tv-artifact-image {\n        width: 24px;\n        height: 24px;\n    }\n    \n    .tv-soul-image {\n        width: 20px;\n        height: 20px;\n    }\n}\n"}};function i(e){try{if(0===e&&window.yourSoul)return window.yourSoul.name||window.yourSoul;if(1===e&&window.enemySoul)return window.enemySoul.name||window.enemySoul;const n=document.querySelectorAll('img[src*="souls"]');if(n&&n[e]){const t=n[e].src.match(/souls\/([^.]+)\.png/);if(t)return t[1].toUpperCase()}}catch(e){console.error("[TournamentView] Error capturando alma del DOM:",e)}return null}function l(e){try{const n=0===e?"yourArtifacts":"enemyArtifacts",t=document.getElementById(n);if(!t)return console.log("[TournamentView] getArtifactsFromDOM - No se encontrÃ³ contenedor:",n),[];const o=t.querySelectorAll(".artifact-group");console.log(`[TournamentView] getArtifactsFromDOM - Player ${e}: ${o.length} artefactos encontrados`);const a=[];return o.forEach((e,n)=>{const t=e.querySelector(".artifact-img");if(t){const o={name:t.getAttribute("name")||"",image:t.getAttribute("image")||"",id:t.getAttribute("artifactid")||"",legendary:"true"===t.getAttribute("legendary")},r=e.querySelector(".artifact-custom");r?(o.counter=parseInt(r.textContent)||0,console.log(`  [${n}] ${o.name}: counter=${o.counter}`)):console.log(`  [${n}] ${o.name}: sin contador`),a.push(o)}}),a}catch(e){console.error("[TournamentView] Error capturando artefactos del DOM:",e)}return[]}function s(e){try{const n=document.querySelectorAll(".dust-counter");console.log("[TournamentView] getGraveyardFromDOM - playerIndex:",e,"Dust counters encontrados:",n.length),n.forEach((e,n)=>{console.log(`  DustCounter[${n}]:`,e.textContent.trim())});const t=0===e?1:0;if(n.length>t&&n[t]){const o=parseInt(n[t].textContent)||0;return console.log(`[TournamentView] Cementerio player ${e} (usando Ã­ndice ${t}): ${o}`),o}const o=document.querySelectorAll("table tr");if(o&&o[e]){const n=o[e].querySelector(".dust-counter");if(n){const t=parseInt(n.textContent)||0;return console.log(`[TournamentView] Cementerio player ${e} (fallback): ${t}`),t}}console.log("[TournamentView] No se pudo encontrar cementerio en DOM")}catch(e){console.error("[TournamentView] Error capturando cementerio del DOM:",e)}return 0}function d(e){if(!e)return null;if(void 0!==e.count)return e.count;if(void 0!==e.counter)return e.counter;if(void 0!==e.value)return e.value;if(e.name){const n=e.name.match(/\((\d+)\)/);if(n)return parseInt(n[1])}return null}const c=new class{constructor(){this.container=null,this.elements={}}initialize(){this.container=document.createElement("div"),this.container.id="uc-tournament-view",document.body.appendChild(this.container),this.createHeader(),this.createActionLog(),console.log("[TournamentView] UI inicializada")}showFloatingNotification(e,n="info",t=3e3){const o=document.createElement("div");o.className="tv-notification tv-notification-"+n,o.textContent=e;const a=60*document.querySelectorAll(".tv-notification").length;o.style.top=90+a+"px",document.body.appendChild(o),setTimeout(()=>{o.classList.add("hiding"),setTimeout(()=>o.remove(),300)},t)}createActionLog(){const e=document.createElement("button");e.className="tv-log-float-toggle",e.innerHTML="ðŸ“œ",e.title="Toggle Historial",document.body.appendChild(e),this.elements.logFloatToggle=e;const n=document.createElement("div");n.className="tv-action-log collapsed",n.innerHTML='\n            <div class="tv-log-header">\n                <span>Historial de Acciones</span>\n                <button class="tv-log-toggle">âœ•</button>\n            </div>\n            <div class="tv-log-content" data-log-content></div>\n        ',document.body.appendChild(n),this.elements.actionLog=n,this.elements.logContent=n.querySelector("[data-log-content]"),this.elements.logToggle=n.querySelector(".tv-log-toggle"),e.addEventListener("click",()=>this.toggleActionLog()),this.elements.logToggle.addEventListener("click",()=>this.toggleActionLog())}toggleActionLog(){this.elements.actionLog.classList.toggle("collapsed")}updateActionLog(){if(!this.elements.logContent)return;const e=a.actionLog;this.elements.logContent.innerHTML=e.slice(0,30).map(e=>`\n                <div class="tv-log-entry ${"tv-log-entry-"+e.type}">\n                    <div class="tv-log-turn">Turno ${e.turn}</div>\n                    <div class="tv-log-player">${e.player}</div>\n                    <div class="tv-log-message">${e.message}</div>\n                </div>\n            `).join("")}createHeader(){const e=document.createElement("div");e.className="tv-header";const n=document.createElement("div");n.className="tv-player-info",n.innerHTML='\n            <div class="tv-player-name" data-player="player">Player</div>\n            <div class="tv-player-soul">\n                <div class="tv-soul-text" data-soul="player">-</div>\n            </div>\n            <div class="tv-player-hp">\n                <div class="tv-hp-bar">\n                    <div class="tv-hp-fill" data-hp-bar="player" style="width: 100%"></div>\n                </div>\n                <div class="tv-hp-text" data-hp-text="player">30/30</div>\n            </div>\n            <div class="tv-player-gold">\n                <div class="tv-gold-text" data-gold="player">0 G</div>\n            </div>\n            <div class="tv-player-artifacts">\n                <div class="tv-artifacts-text" data-artifacts="player">-</div>\n            </div>\n            <div class="tv-player-cards">\n                <div class="tv-card-counter">\n                    <div class="tv-card-counter-label">Mano</div>\n                    <div class="tv-card-counter-value" data-hand="player">0</div>\n                </div>\n                <div class="tv-card-counter">\n                    <div class="tv-card-counter-label">Mazo</div>\n                    <div class="tv-card-counter-value" data-deck="player">0</div>\n                </div>\n                <div class="tv-card-counter">\n                    <div class="tv-card-counter-label">Cementerio</div>\n                    <div class="tv-card-counter-value" data-graveyard="player">0</div>\n                </div>\n            </div>\n        ';const t=document.createElement("div");t.className="tv-center-info",t.innerHTML='\n            <div class="tv-turn-indicator">\n                <div class="tv-turn-label">Turno</div>\n                <div class="tv-turn-number" data-turn>0</div>\n                <div class="tv-turn-timer" data-timer>-</div>\n            </div>\n        ';const o=document.createElement("div");o.className="tv-opponent-info",o.innerHTML='\n            <div class="tv-player-name" data-player="opponent">Opponent</div>\n            <div class="tv-player-soul">\n                <div class="tv-soul-text" data-soul="opponent">-</div>\n            </div>\n            <div class="tv-player-hp">\n                <div class="tv-hp-bar">\n                    <div class="tv-hp-fill" data-hp-bar="opponent" style="width: 100%"></div>\n                </div>\n                <div class="tv-hp-text" data-hp-text="opponent">30/30</div>\n            </div>\n            <div class="tv-player-gold">\n                <div class="tv-gold-text" data-gold="opponent">0 G</div>\n            </div>\n            <div class="tv-player-artifacts">\n                <div class="tv-artifacts-text" data-artifacts="opponent">-</div>\n            </div>\n            <div class="tv-player-cards">\n                <div class="tv-card-counter">\n                    <div class="tv-card-counter-label">Mano</div>\n                    <div class="tv-card-counter-value" data-hand="opponent">0</div>\n                </div>\n                <div class="tv-card-counter">\n                    <div class="tv-card-counter-label">Mazo</div>\n                    <div class="tv-card-counter-value" data-deck="opponent">0</div>\n                </div>\n                <div class="tv-card-counter">\n                    <div class="tv-card-counter-label">Cementerio</div>\n                    <div class="tv-card-counter-value" data-graveyard="opponent">0</div>\n                </div>\n            </div>\n        ',e.appendChild(n),e.appendChild(t),e.appendChild(o),this.container.appendChild(e),this.elements.playerName=n.querySelector('[data-player="player"]'),this.elements.opponentName=o.querySelector('[data-player="opponent"]'),this.elements.playerSoul=n.querySelector('[data-soul="player"]'),this.elements.opponentSoul=o.querySelector('[data-soul="opponent"]'),this.elements.playerHpBar=n.querySelector('[data-hp-bar="player"]'),this.elements.opponentHpBar=o.querySelector('[data-hp-bar="opponent"]'),this.elements.playerHpText=n.querySelector('[data-hp-text="player"]'),this.elements.opponentHpText=o.querySelector('[data-hp-text="opponent"]'),this.elements.playerGold=n.querySelector('[data-gold="player"]'),this.elements.opponentGold=o.querySelector('[data-gold="opponent"]'),this.elements.playerArtifacts=n.querySelector('[data-artifacts="player"]'),this.elements.opponentArtifacts=o.querySelector('[data-artifacts="opponent"]'),this.elements.playerHand=n.querySelector('[data-hand="player"]'),this.elements.opponentHand=o.querySelector('[data-hand="opponent"]'),this.elements.playerDeck=n.querySelector('[data-deck="player"]'),this.elements.opponentDeck=o.querySelector('[data-deck="opponent"]'),this.elements.playerGraveyard=n.querySelector('[data-graveyard="player"]'),this.elements.opponentGraveyard=o.querySelector('[data-graveyard="opponent"]'),this.elements.turnNumber=t.querySelector("[data-turn]"),this.elements.turnTimer=t.querySelector("[data-timer]")}updatePlayerNames(){this.elements.playerName&&a.player.username&&(this.elements.playerName.textContent=a.player.username),this.elements.opponentName&&a.opponent.username&&(this.elements.opponentName.textContent=a.opponent.username)}updateHP(e="player"){const n="player"===e?a.player:a.opponent,t=this.elements[e+"HpBar"],o=this.elements[e+"HpText"];if(t&&o&&n.maxHp>0){const a=n.hp/n.maxHp*100,r=a-(parseFloat(t.style.width)||100);if(t.style.width=a+"%",o.textContent=`${n.hp}/${n.maxHp}`,r<0){t.classList.add("hp-damage"),setTimeout(()=>t.classList.remove("hp-damage"),500);const o=n.username||("player"===e?"Player":"Opponent"),a=Math.abs(Math.round(r*n.maxHp/100));this.showFloatingNotification(`${o} recibiÃ³ ${a} de daÃ±o`,"damage",2500)}else if(r>0){t.classList.add("hp-heal"),setTimeout(()=>t.classList.remove("hp-heal"),500);const o=n.username||("player"===e?"Player":"Opponent"),a=Math.round(r*n.maxHp/100);this.showFloatingNotification(`${o} sanÃ³ ${a} HP`,"heal",2500)}}}updateGold(e="player"){const n="player"===e?a.player:a.opponent,t=this.elements[e+"Gold"];t&&(t.textContent=n.gold+" G")}updateTurn(){this.elements.turnNumber&&(this.elements.turnNumber.textContent=a.turn)}updateSoul(e="player"){const n="player"===e?a.player:a.opponent,t=this.elements[e+"Soul"];if(console.log(`[TournamentView] updateSoul(${e}) - Soul data:`,n.soul,"Type:",typeof n.soul),t)if(n.soul&&""!==n.soul){t.innerHTML="";const o=function(e){if(!e)return null;let n=null;if("string"==typeof e)try{const t=JSON.parse(e);n=t.name||t.id||t}catch(t){n=e}else e&&(e.name||e.id)&&(n=e.name||e.id);if(!n)return null;const t=document.querySelectorAll('img[src*="souls"]');console.log("[TournamentView] Buscando alma:",n,"ImÃ¡genes encontradas:",t.length);for(const e of t)if(console.log("[TournamentView] Imagen encontrada:",e.src),e.src.toLowerCase().includes(n.toLowerCase()))return console.log("[TournamentView] Â¡Imagen coincide! Usando:",e.src),e.src;return console.log("[TournamentView] No se encontrÃ³ en DOM, construyendo URL"),`images/souls/${n.toLowerCase()}.png`}(n.soul);if(console.log(`[TournamentView] updateSoul(${e}) - Image URL:`,o),o){const a=document.createElement("img");a.src=o,a.alt="string"==typeof n.soul?n.soul:n.soul.name,a.className="tv-soul-image",a.style.width="24px",a.style.height="24px",a.style.objectFit="contain",a.style.filter="drop-shadow(1px 1px 2px rgba(0, 0, 0, 0.8))",a.setAttribute(`data-${e}-soul`,"true"),a.onerror=()=>{console.error("[TournamentView] Error cargando imagen de alma:",o),t.textContent="string"==typeof n.soul?n.soul:n.soul.name},t.appendChild(a),t.title="Soul: "+("string"==typeof n.soul?n.soul:n.soul.name)}else t.textContent="string"==typeof n.soul?n.soul:n.soul.name,t.title="Soul: "+("string"==typeof n.soul?n.soul:n.soul.name)}else console.log(`[TournamentView] updateSoul(${e}) - No soul data, showing dash`),t.textContent="-";else console.error(`[TournamentView] updateSoul(${e}) - Element not found!`)}updateArtifacts(e="player"){const n="player"===e?a.player:a.opponent,t=this.elements[e+"Artifacts"];if(t)if(n.artifacts&&n.artifacts.length>0){t.innerHTML="",t.style.display="flex",t.style.gap="0.25rem",t.style.alignItems="center",n.artifacts.forEach((e,o)=>{const a=document.createElement("div");a.style.position="relative",a.style.display="inline-block";const r=function(e){if(!e)return null;if(e.image)return`https://undercards.net/images/artifacts/${e.image}.png`;if(e.id){const n=document.querySelector(`img[src*="artifacts"][src*="${e.id}"]`);return n?n.src:`https://undercards.net/images/artifacts/${e.id}.png`}return e.name?`https://undercards.net/images/artifacts/${e.name.toLowerCase().replace(/\s+/g,"_")}.png`:null}(e);if(r){const n=document.createElement("img");if(n.src=r,n.alt=e.name||"Artifact",n.className="tv-artifact-image",n.style.width="36px",n.style.height="36px",n.style.objectFit="contain",n.style.filter="drop-shadow(2px 2px 3px rgba(0, 0, 0, 0.9))",e.id&&n.setAttribute("data-artifact-id",e.id),n.onerror=()=>{a.innerHTML="";const n=document.createElement("span");n.textContent=e.name+(e.counter?`(${e.counter})`:""),n.style.fontSize="0.875rem",n.style.color="#a78bfa",n.style.fontWeight="bold",a.appendChild(n)},a.appendChild(n),e.counter){const n=document.createElement("div");n.textContent=e.counter,n.style.position="absolute",n.style.top="-6px",n.style.right="-6px",n.style.background="linear-gradient(135deg, #ef4444 0%, #dc2626 100%)",n.style.color="#ffffff",n.style.borderRadius="50%",n.style.width="22px",n.style.height="22px",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.fontSize="0.75rem",n.style.fontWeight="bold",n.style.border="2px solid #ffffff",n.style.boxShadow="0 3px 6px rgba(0, 0, 0, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.3)",n.style.textShadow="0 1px 2px rgba(0, 0, 0, 0.8)",a.appendChild(n)}a.title=e.name+(e.counter?` (${e.counter})`:"")}else{const n=document.createElement("span");n.textContent=e.name+(e.counter?`(${e.counter})`:""),n.style.fontSize="0.875rem",n.style.color="#a78bfa",n.style.fontWeight="bold",a.appendChild(n)}if(t.appendChild(a),o<n.artifacts.length-1){const e=document.createElement("span");e.textContent=",",e.style.fontSize="0.75rem",e.style.color="#666",e.style.marginRight="0.25rem",t.appendChild(e)}});const e=n.artifacts.map(e=>e.name+(e.counter?`(${e.counter})`:"")).join(", ");t.title=e}else t.textContent="-",t.title="Sin artefactos"}updateCards(e="player"){const n="player"===e?a.player:a.opponent,t=this.elements[e+"Hand"],o=this.elements[e+"Deck"],r=this.elements[e+"Graveyard"];t&&(t.textContent=n.handCount),o&&(o.textContent=n.deckCount),r&&(r.textContent=n.graveyardCount)}updateTimer(e){if(this.elements.turnTimer)if(null!=e&&e>=0){const n=`${Math.floor(e/60)}:${(e%60).toString().padStart(2,"0")}`;this.elements.turnTimer.textContent=n,e<=10?this.elements.turnTimer.classList.add("low"):this.elements.turnTimer.classList.remove("low")}else this.elements.turnTimer.textContent="-",this.elements.turnTimer.classList.remove("low")}updateActivePlayer(){const e=this.container.querySelector(".tv-player-info"),n=this.container.querySelector(".tv-opponent-info");console.log("[TournamentView] updateActivePlayer - Player ID:",a.player.id,"Opponent ID:",a.opponent.id,"Current:",a.currentPlayer),e&&n?(e.classList.remove("active-turn"),n.classList.remove("active-turn"),a.currentPlayer===a.player.id?(console.log("[TournamentView] Marcando JUGADOR como activo"),e.classList.add("active-turn")):a.currentPlayer===a.opponent.id?(console.log("[TournamentView] Marcando OPONENTE como activo"),n.classList.add("active-turn")):console.log("[TournamentView] Advertencia: currentPlayer no coincide con ningÃºn ID")):console.error("[TournamentView] No se encontraron elementos playerInfo u opponentInfo")}showResult(e){const n=document.createElement("div");n.className="tv-result-overlay";const t="victory"===e?"Â¡VICTORIA!":"DERROTA",o="victory"===e?"victory":"defeat";n.innerHTML=`\n            <div class="tv-result-container">\n                <div class="tv-result-title ${o}">${t}</div>\n                <div class="tv-result-stats">\n                    <div class="tv-result-stat">\n                        <span class="tv-result-stat-label">Turnos totales:</span>\n                        <span class="tv-result-stat-value">${a.turn}</span>\n                    </div>\n                    <div class="tv-result-stat">\n                        <span class="tv-result-stat-label">HP Final:</span>\n                        <span class="tv-result-stat-value">${a.player.hp}/${a.player.maxHp}</span>\n                    </div>\n                </div>\n            </div>\n        `,this.container.appendChild(n),setTimeout(()=>{n.parentNode&&(n.style.opacity="0",setTimeout(()=>n.remove(),500))},5e3)}destroy(){this.container&&this.container.parentNode&&this.container.remove(),this.container=null,this.elements={}}};let p=null;const u=o.settings().add({key:"enabled",name:"Activar Tournament View",type:"boolean",default:!1});console.log("[TournamentView] Setting creado - isEnabled:",u),console.log("[TournamentView] Setting creado - isEnabled.value():",u.value()),console.log("[TournamentView] Setting creado - typeof isEnabled.value():",typeof u.value()),u.on("change",e=>{console.log("[TournamentView] Setting cambiado a:",e),e?(console.log("[TournamentView] Activando plugin..."),t.onPage("Spectate")&&(a.isSpectate=!0,r.injectCSS(),c.initialize(),console.log("[TournamentView] Plugin activado"))):(console.log("[TournamentView] Desactivando plugin..."),p&&(clearInterval(p),p=null),c.destroy(),r.removeCSS(),a.reset(),console.log("[TournamentView] Plugin desactivado"))}),o.events.on(":preload",()=>{console.log("[TournamentView] :preload - isEnabled.value():",u.value()),u.value()?t.onPage("Spectate")?(a.isSpectate=!0,console.log("[TournamentView] Plugin cargado en modo Spectate"),r.injectCSS(),c.initialize()):console.log("[TournamentView] No estamos en Spectate, plugin inactivo"):console.log("[TournamentView] Plugin DESACTIVADO - No se iniciarÃ¡")}),o.events.on("connect",e=>{if(console.log("[TournamentView] connect - isEnabled.value():",u.value(),"isSpectate:",a.isSpectate),u.value()&&a.isSpectate){console.log("[TournamentView] ConexiÃ³n establecida:",e);try{const n=e.you?JSON.parse(e.you):null,t=e.enemy?JSON.parse(e.enemy):null,o=e.golds?JSON.parse(e.golds):{};if(void 0!==e.turn&&null!==e.turn&&(a.turn=parseInt(e.turn)||0,console.log("[TournamentView] Turno inicial capturado:",a.turn)),void 0!==e.userTurn&&(a.currentPlayer=e.userTurn,console.log("[TournamentView] Turno activo de:",e.userTurn)),n&&(a.player.id=n.id,a.player.username=n.username||"Player",a.player.hp=n.hp||30,a.player.maxHp=n.maxHp||30,a.player.gold=o[n.id]||0,a.player.soul=e.yourSoul||i(0)||"",a.player.soulLives=0,console.log("[TournamentView] Player soul captured:",a.player.soul,"Type:",typeof a.player.soul),e.artifacts))try{const t=JSON.parse(e.artifacts);t[n.id]&&(a.player.artifacts=t[n.id],console.log("[TournamentView] Artefactos del jugador:",a.player.artifacts),a.player.artifacts.forEach(e=>{const n=d(e);console.log(`  - ${e.name}:`,"counter:",n,"image:",e.image,"id:",e.id),null!==n&&(e.counter=n)}))}catch(e){console.error("[TournamentView] Error parseando artefactos del jugador:",e)}if(t&&(a.opponent.id=t.id,a.opponent.username=t.username||"Opponent",a.opponent.hp=t.hp||30,a.opponent.maxHp=t.maxHp||30,a.opponent.gold=o[t.id]||0,a.opponent.soul=e.enemySoul||i(1)||"",a.opponent.soulLives=0,console.log("[TournamentView] Opponent soul captured:",a.opponent.soul,"Type:",typeof a.opponent.soul),e.artifacts))try{const n=JSON.parse(e.artifacts);n[t.id]&&(a.opponent.artifacts=n[t.id],console.log("[TournamentView] Artefactos del oponente:",a.opponent.artifacts),a.opponent.artifacts.forEach(e=>{const n=d(e);console.log(`  - ${e.name}:`,"counter:",n,"image:",e.image,"id:",e.id),null!==n&&(e.counter=n)}))}catch(e){console.error("[TournamentView] Error parseando artefactos del oponente:",e)}if(e.handsSize)try{const o=JSON.parse(e.handsSize);n&&void 0!==o[n.id]&&(a.player.handCount=o[n.id]),t&&void 0!==o[t.id]&&(a.opponent.handCount=o[t.id])}catch(e){console.error("[TournamentView] Error parseando handsSize inicial:",e)}if(e.decksSize)try{const o=JSON.parse(e.decksSize);n&&void 0!==o[n.id]&&(a.player.deckCount=o[n.id]),t&&void 0!==o[t.id]&&(a.opponent.deckCount=o[t.id])}catch(e){console.error("[TournamentView] Error parseando decksSize inicial:",e)}if(e.graveyardsSize)try{const o=JSON.parse(e.graveyardsSize);n&&void 0!==o[n.id]?a.player.graveyardCount=o[n.id]:n&&(a.player.graveyardCount=s(0)),t&&void 0!==o[t.id]?a.opponent.graveyardCount=o[t.id]:t&&(a.opponent.graveyardCount=s(1))}catch(e){console.error("[TournamentView] Error parseando graveyardsSize inicial:",e),n&&(a.player.graveyardCount=s(0)),t&&(a.opponent.graveyardCount=s(1))}else n&&(a.player.graveyardCount=s(0)),t&&(a.opponent.graveyardCount=s(1));console.log("[TournamentView] Jugador:",a.player.username,`[${a.player.soul}]`,`(${a.player.hp} HP, ${a.player.gold} G)`,`Cartas: ${a.player.handCount}/${a.player.deckCount}/${a.player.graveyardCount}`,a.player.artifacts.length>0?"Artefactos: "+a.player.artifacts.length:""),console.log("[TournamentView] Oponente:",a.opponent.username,`[${a.opponent.soul}]`,`(${a.opponent.hp} HP, ${a.opponent.gold} G)`,`Cartas: ${a.opponent.handCount}/${a.opponent.deckCount}/${a.opponent.graveyardCount}`,a.opponent.artifacts.length>0?"Artefactos: "+a.opponent.artifacts.length:""),c.updatePlayerNames(),c.updateHP("player"),c.updateHP("opponent"),c.updateGold("player"),c.updateGold("opponent"),c.updateSoul("player"),c.updateSoul("opponent"),c.updateArtifacts("player"),c.updateArtifacts("opponent"),c.updateCards("player"),c.updateCards("opponent"),c.updateTurn(),c.updateActivePlayer()}catch(e){console.error("[TournamentView] Error parseando datos de conexiÃ³n:",e)}}else console.log("[TournamentView] connect - Plugin desactivado o no en modo espectador, ignorando evento")}),o.events.on("GameStart",e=>{console.log("[TournamentView] GameStart - isEnabled.value():",u.value(),"isSpectate:",a.isSpectate),u.value()&&a.isSpectate?(console.log("[TournamentView] Partida iniciada:",e),a.isActive=!0,a.turn=0,c.updateTurn()):console.log("[TournamentView] GameStart - Ignorando evento (desactivado o no espectador)")}),o.events.on("getTurnStart",e=>{if(console.log("[TournamentView] getTurnStart - isEnabled.value():",u.value(),"isActive:",a.isActive),!u.value()||!a.isActive)return void console.log("[TournamentView] getTurnStart - Ignorando evento");window.global&&void 0!==window.global("turn")?a.turn=window.global("turn"):void 0!==e.numTurn?a.turn=parseInt(e.numTurn):void 0!==e.turn&&(a.turn=parseInt(e.turn)),void 0!==e.idPlayer?a.currentPlayer=e.idPlayer:void 0!==e.playerId&&(a.currentPlayer=e.playerId),console.log(`[TournamentView] Turno ${a.turn} iniciado`),console.log(`[TournamentView] IDs - Player: ${a.player.id}, Opponent: ${a.opponent.id}, Current: ${a.currentPlayer}`);const n=a.currentPlayer===a.player.id?a.player.username:a.opponent.username;a.addAction("turn",n,`Turno ${a.turn} iniciado`),c.updateActionLog(),c.updateActivePlayer(),p&&clearInterval(p),p=setInterval(()=>{try{const e=window.global?window.global("time"):null;if(null!=e)c.updateTimer(Math.max(0,e));else{const e=document.querySelector(".timer");if(e&&e.textContent){const n=e.textContent.trim().split(":");if(2===n.length){const e=parseInt(n[0])||0,t=60*e+(parseInt(n[1])||0);c.updateTimer(t)}}}}catch(e){console.error("[TournamentView] Error leyendo timer:",e)}},500),c.updateTurn()}),o.events.on("getUpdatePlayerHp",e=>{if(!u.value()||!a.isActive)return;const n=e.playerId===a.player.id,t=n?a.player:a.opponent,o=t.hp;n?(a.updatePlayer({hp:e.hp,maxHp:e.maxHp}),c.updateHP("player")):e.playerId===a.opponent.id&&(a.updateOpponent({hp:e.hp,maxHp:e.maxHp}),c.updateHP("opponent"));const r=e.hp-o;if(0!==r){const e=t.username||(n?"Player":"Opponent"),o=r<0?`perdiÃ³ ${Math.abs(r)} HP`:`ganÃ³ ${r} HP`;a.addAction("hp",e,o),c.updateActionLog()}console.log("[TournamentView] HP actualizado:",e)}),o.events.on("getPlayersStats",e=>{if(u.value()&&a.isActive)try{if(e.golds){const n=JSON.parse(e.golds);a.player.id&&void 0!==n[a.player.id]&&(a.player.gold=n[a.player.id],c.updateGold("player")),a.opponent.id&&void 0!==n[a.opponent.id]&&(a.opponent.gold=n[a.opponent.id],c.updateGold("opponent"))}if(e.handsSize){const n=JSON.parse(e.handsSize);a.player.id&&void 0!==n[a.player.id]&&(a.player.handCount=n[a.player.id],c.updateCards("player")),a.opponent.id&&void 0!==n[a.opponent.id]&&(a.opponent.handCount=n[a.opponent.id],c.updateCards("opponent"))}if(e.decksSize){const n=JSON.parse(e.decksSize);a.player.id&&void 0!==n[a.player.id]&&(a.player.deckCount=n[a.player.id],c.updateCards("player")),a.opponent.id&&void 0!==n[a.opponent.id]&&(a.opponent.deckCount=n[a.opponent.id],c.updateCards("opponent"))}if(e.graveyardsSize){const n=JSON.parse(e.graveyardsSize);console.log("[TournamentView] graveyardsSize recibido:",n),a.player.id&&void 0!==n[a.player.id]&&(a.player.graveyardCount=n[a.player.id],console.log("[TournamentView] Cementerio player actualizado a:",a.player.graveyardCount),c.updateCards("player")),a.opponent.id&&void 0!==n[a.opponent.id]&&(a.opponent.graveyardCount=n[a.opponent.id],console.log("[TournamentView] Cementerio opponent actualizado a:",a.opponent.graveyardCount),c.updateCards("opponent"))}else{console.log("[TournamentView] No graveyardsSize en getPlayersStats, intentando leer del DOM");const e=s(0),n=s(1);e!==a.player.graveyardCount&&(a.player.graveyardCount=e,console.log("[TournamentView] Cementerio player actualizado desde DOM a:",e),c.updateCards("player")),n!==a.opponent.graveyardCount&&(a.opponent.graveyardCount=n,console.log("[TournamentView] Cementerio opponent actualizado desde DOM a:",n),c.updateCards("opponent"))}console.log("[TournamentView] Leyendo artefactos desde DOM...");const n=l(0),t=l(1),o=JSON.stringify(a.player.artifacts);o!==JSON.stringify(n)&&n.length>0&&(a.player.artifacts=n,console.log("[TournamentView] Artefactos del jugador actualizados desde DOM:",n.map(e=>`${e.name}${e.counter?`(${e.counter})`:""}`).join(", ")),c.updateArtifacts("player"));const r=JSON.stringify(a.opponent.artifacts);r!==JSON.stringify(t)&&t.length>0&&(a.opponent.artifacts=t,console.log("[TournamentView] Artefactos del oponente actualizados desde DOM:",t.map(e=>`${e.name}${e.counter?`(${e.counter})`:""}`).join(", ")),c.updateArtifacts("opponent"));const i=a.player.artifacts.length>0?` | ${a.player.artifacts.length} artefactos`:"",d=a.opponent.artifacts.length>0?` | ${a.opponent.artifacts.length} artefactos`:"";console.log(`[TournamentView] Stats - P: ${a.player.gold}G, ${a.player.handCount} cartas${i} | O: ${a.opponent.gold}G, ${a.opponent.handCount} cartas${d}`)}catch(e){console.error("[TournamentView] Error parseando stats:",e)}}),o.events.on("getUpdateBoard",e=>{if(u.value()&&a.isActive)try{const n=JSON.parse(e.board);let t=0,o=0;n.forEach((e,n)=>{e&&(e.ownerId===a.player.id?t++:e.ownerId===a.opponent.id&&o++)}),a.player.boardCount=t,a.opponent.boardCount=o,console.log("[TournamentView] Tablero actualizado - P:",t,"cartas | O:",o,"cartas")}catch(e){console.error("[TournamentView] Error parseando tablero:",e)}}),o.events.on("getVictory",e=>{u.value()&&a.isActive&&(a.gameResult="victory",console.log("[TournamentView] Victoria detectada"),c.showResult("victory"))}),o.events.on("getDefeat",e=>{u.value()&&a.isActive&&(a.gameResult="defeat",console.log("[TournamentView] Derrota detectada"),c.showResult("defeat"))}),o.events.on("getResult",e=>{u.value()&&a.isActive&&(console.log("[TournamentView] Partida finalizada:",e),setTimeout(()=>{const e=a.getState();console.log("[TournamentView] Estado final:",e)},1e3))}),o.events.on("getCardBoard",e=>{if(u.value()&&a.isActive)try{const n=JSON.parse(e.card),t=e.idPlayer===a.player.id?a.player.username:a.opponent.username;console.log(`[TournamentView] ${t} jugÃ³: ${n.name}`),c.showFloatingNotification(`${t} jugÃ³ ${n.name}`,"card",3e3),a.addAction("card",t,"jugÃ³ "+n.name),c.updateActionLog()}catch(e){console.error("[TournamentView] Error parseando carta:",e)}}),o.events.on("getSpellPlayed",e=>{if(u.value()&&a.isActive)try{const n=JSON.parse(e.card),t=e.idPlayer===a.player.id?a.player.username:a.opponent.username;console.log(`[TournamentView] ${t} usÃ³ hechizo: ${n.name}`),c.showFloatingNotification(`${t} usÃ³ ${n.name}`,"spell",3e3),a.addAction("spell",t,"usÃ³ hechizo "+n.name),c.updateActionLog()}catch(e){console.error("[TournamentView] Error parseando hechizo:",e)}}),o.events.on("getMonsterDestroyed",e=>{u.value()&&a.isActive&&(console.log("[TournamentView] Monstruo destruido, ID:",e.monsterId),c.showFloatingNotification("Monstruo destruido","damage",2e3),a.addAction("monster","Sistema","Monstruo destruido"),c.updateActionLog())}),o.events.on("getUpdateSoul",e=>{if(u.value()&&a.isActive)try{const n=JSON.parse(e.soul);e.idPlayer===a.player.id?(a.player.soulLives=n.lives||0,console.log(`[TournamentView] Alma del jugador actualizada: ${a.player.soul} (Vidas: ${n.lives}, Esquiva: ${n.dodge||0})`),c.updateSoul("player")):e.idPlayer===a.opponent.id&&(a.opponent.soulLives=n.lives||0,console.log(`[TournamentView] Alma del oponente actualizada: ${a.opponent.soul} (Vidas: ${n.lives}, Esquiva: ${n.dodge||0})`),c.updateSoul("opponent"))}catch(e){console.error("[TournamentView] Error parseando actualizaciÃ³n de alma:",e)}}),o.events.on("Log:ARTIFACT_EFFECT",e=>{if(u.value()&&a.isActive)try{const n=e.artifactActor&&e.artifactActor.name||"Artefacto desconocido",t=e.playerId===a.player.id?a.player.username:a.opponent.username;if(console.log(`[TournamentView] ${t} activÃ³ artefacto: ${n}`),c.showFloatingNotification(`${t} activÃ³ ${n}`,"artifact",3e3),a.addAction("artifact",t,"activÃ³ "+n),c.updateActionLog(),e.artifactActor&&e.artifactActor.id){document.querySelectorAll(`.tv-artifact-image[data-artifact-id="${e.artifactActor.id}"]`).forEach(e=>{e.classList.add("artifact-glow"),setTimeout(()=>e.classList.remove("artifact-glow"),1200)})}e.targetCards&&e.targetCards.length>0&&console.log("[TournamentView] AfectÃ³ a cartas:",e.targetCards.length),e.targetPlayers&&e.targetPlayers.length>0&&console.log("[TournamentView] AfectÃ³ a jugadores:",e.targetPlayers.length)}catch(e){console.error("[TournamentView] Error procesando efecto de artefacto:",e)}}),o.events.on("Log:SOUL_EFFECT",e=>{if(u.value()&&a.isActive)try{const n=e.playerId===a.player.id,t=n?a.player.username:a.opponent.username,o=n?a.player.soul:a.opponent.soul;console.log(`[TournamentView] ${t} activÃ³ efecto del alma: ${o}`),c.showFloatingNotification(t+" activÃ³ efecto de alma","info",2500),a.addAction("soul",t,"activÃ³ efecto de "+o),c.updateActionLog();const r=n?"[data-player-soul]":"[data-opponent-soul]",i=document.querySelector(r);i&&(i.classList.add("soul-glow"),setTimeout(()=>i.classList.remove("soul-glow"),1e3))}catch(e){console.error("[TournamentView] Error procesando efecto del alma:",e)}}),o.events.on("getTurnEnd",e=>{u.value()&&a.isActive&&(p&&(clearInterval(p),p=null),c.updateTimer(null),console.log("[TournamentView] Turno finalizado"))}),o.events.on("refreshTimer",e=>{if(u.value()&&a.isActive)try{if(void 0!==e.time&&null!==e.time){const n=parseInt(e.time);c.updateTimer(Math.max(0,n))}}catch(e){console.error("[TournamentView] Error procesando timer:",e)}})}]);