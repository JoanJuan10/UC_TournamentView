# Canon Consistency Check
# Verifica que la documentaciÃ³n del proyecto sea consistente y estÃ© actualizada

name: Canon Consistency Check

on:
  push:
    branches: [main, master]
    paths:
      - 'docs/**'
      - 'README.md'
      - 'src/**'
  pull_request:
    branches: [main, master]
    paths:
      - 'docs/**'
      - 'README.md'
      - 'src/**'
  workflow_dispatch:

jobs:
  canon-check:
    name: Verificar Consistencia del Canon
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Verificar estructura de documentaciÃ³n
        id: structure-check
        run: |
          echo "ðŸ“ Verificando estructura de archivos..."
          
          REQUIRED_FILES=(
            "README.md"
            "docs/00_INDICE.md"
            "docs/01_TAMPERMONKEY.md"
            "docs/02_UNDERSCRIPT_PLUGIN_API.md"
            "docs/03_EVENTOS_JUEGO.md"
            "docs/04_VARIABLES_GLOBALES.md"
            "docs/05_LIBRERIAS_INCLUIDAS.md"
            "docs/06_ESPECIFICACION_PROYECTO.md"
            "docs/07_DESARROLLO.md"
            "docs/08_ESTADO_ACTUAL.md"
            "docs/09_LECCIONES_APRENDIDAS.md"
            "docs/10_FASE4_PLANTILLAS.md"
            "docs/11_FASE4_RESUMEN.md"
            "docs/12_CANON_CHECK.md"
            "docs/13_MANTENIMIENTO_DIC_2025.md"
            "docs/16_FASE4_BUGS_RESUELTOS.md"
            "docs/TESTING_GUIDE.md"
          )
          
          MISSING_FILES=()
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              MISSING_FILES+=("$file")
              echo "âŒ Falta: $file"
            else
              echo "âœ… Existe: $file"
            fi
          done
          
          if [ ${#MISSING_FILES[@]} -gt 0 ]; then
            echo "::error::Faltan ${#MISSING_FILES[@]} archivo(s) de documentaciÃ³n requeridos"
            exit 1
          fi
          
          echo "âœ… Todos los archivos de documentaciÃ³n existen"

      - name: Verificar enlaces internos en documentaciÃ³n
        id: links-check
        run: |
          echo "ðŸ”— Verificando enlaces internos..."
          
          BROKEN_LINKS=()
          
          # FunciÃ³n para verificar enlaces markdown
          check_links() {
            local file=$1
            echo "Analizando: $file"
            
            # Extraer enlaces markdown [texto](ruta)
            # Filtrar URLs externas (http://, https://)
            links=$(grep -oP '\[.*?\]\(\K[^)]+(?=\))' "$file" 2>/dev/null | grep -v '^http' | grep -v '^#' || true)
            
            for link in $links; do
              # Limpiar el enlace (quitar anclas #)
              clean_link=$(echo "$link" | sed 's/#.*//')
              
              if [ -n "$clean_link" ]; then
                # Resolver ruta relativa desde el directorio del archivo
                dir=$(dirname "$file")
                target="$dir/$clean_link"
                
                # Normalizar la ruta
                target=$(realpath -m "$target" 2>/dev/null || echo "$target")
                
                if [ ! -f "$target" ]; then
                  echo "âŒ Enlace roto en $file: $link -> $target"
                  BROKEN_LINKS+=("$file: $link")
                fi
              fi
            done
          }
          
          # Verificar README.md
          check_links "README.md"
          
          # Verificar todos los .md en docs/
          for doc in docs/*.md; do
            if [ -f "$doc" ]; then
              check_links "$doc"
            fi
          done
          
          if [ ${#BROKEN_LINKS[@]} -gt 0 ]; then
            echo "::error::Se encontraron ${#BROKEN_LINKS[@]} enlace(s) roto(s)"
            exit 1
          fi
          
          echo "âœ… Todos los enlaces internos son vÃ¡lidos"

      - name: Verificar Ã­ndice en README.md
        id: index-check
        run: |
          echo "ðŸ“‹ Verificando que el README incluya todos los documentos..."
          
          MISSING_REFS=()
          
          # Documentos que deben estar referenciados en README.md
          DOCS=(
            "01_TAMPERMONKEY.md"
            "02_UNDERSCRIPT_PLUGIN_API.md"
            "03_EVENTOS_JUEGO.md"
            "04_VARIABLES_GLOBALES.md"
            "05_LIBRERIAS_INCLUIDAS.md"
            "06_ESPECIFICACION_PROYECTO.md"
          )
          
          for doc in "${DOCS[@]}"; do
            if ! grep -q "$doc" README.md; then
              MISSING_REFS+=("$doc")
              echo "âŒ No referenciado en README: $doc"
            else
              echo "âœ… Referenciado: $doc"
            fi
          done
          
          if [ ${#MISSING_REFS[@]} -gt 0 ]; then
            echo "::warning::${#MISSING_REFS[@]} documento(s) no estÃ¡n referenciados en README.md"
          fi
          
          echo "âœ… VerificaciÃ³n de Ã­ndice completada"

      - name: Verificar navegaciÃ³n entre documentos
        id: navigation-check
        run: |
          echo "ðŸ§­ Verificando navegaciÃ³n secuencial..."
          
          NAVIGATION_ISSUES=()
          
          # Verificar que cada doc tenga enlaces al anterior y siguiente
          declare -A NAV_PREV
          declare -A NAV_NEXT
          
          NAV_PREV["02_UNDERSCRIPT_PLUGIN_API.md"]="01_TAMPERMONKEY.md"
          NAV_PREV["03_EVENTOS_JUEGO.md"]="02_UNDERSCRIPT_PLUGIN_API.md"
          NAV_PREV["04_VARIABLES_GLOBALES.md"]="03_EVENTOS_JUEGO.md"
          NAV_PREV["05_LIBRERIAS_INCLUIDAS.md"]="04_VARIABLES_GLOBALES.md"
          NAV_PREV["06_ESPECIFICACION_PROYECTO.md"]="05_LIBRERIAS_INCLUIDAS.md"
          
          NAV_NEXT["01_TAMPERMONKEY.md"]="02_UNDERSCRIPT_PLUGIN_API.md"
          NAV_NEXT["02_UNDERSCRIPT_PLUGIN_API.md"]="03_EVENTOS_JUEGO.md"
          NAV_NEXT["03_EVENTOS_JUEGO.md"]="04_VARIABLES_GLOBALES.md"
          NAV_NEXT["04_VARIABLES_GLOBALES.md"]="05_LIBRERIAS_INCLUIDAS.md"
          NAV_NEXT["05_LIBRERIAS_INCLUIDAS.md"]="06_ESPECIFICACION_PROYECTO.md"
          
          for doc in docs/*.md; do
            if [ -f "$doc" ]; then
              filename=$(basename "$doc")
              
              # Verificar enlace al documento anterior
              if [ -n "${NAV_PREV[$filename]}" ]; then
                if ! grep -q "${NAV_PREV[$filename]}" "$doc"; then
                  echo "âš ï¸ $filename no tiene enlace a documento anterior: ${NAV_PREV[$filename]}"
                  NAVIGATION_ISSUES+=("$filename: falta enlace a ${NAV_PREV[$filename]}")
                fi
              fi
              
              # Verificar enlace al documento siguiente
              if [ -n "${NAV_NEXT[$filename]}" ]; then
                if ! grep -q "${NAV_NEXT[$filename]}" "$doc"; then
                  echo "âš ï¸ $filename no tiene enlace a documento siguiente: ${NAV_NEXT[$filename]}"
                  NAVIGATION_ISSUES+=("$filename: falta enlace a ${NAV_NEXT[$filename]}")
                fi
              fi
            fi
          done
          
          if [ ${#NAVIGATION_ISSUES[@]} -gt 0 ]; then
            echo "::warning::Se encontraron ${#NAVIGATION_ISSUES[@]} problema(s) de navegaciÃ³n"
          else
            echo "âœ… NavegaciÃ³n entre documentos correcta"
          fi

      - name: Verificar consistencia de versiones
        id: version-check
        run: |
          echo "ðŸ·ï¸ Verificando consistencia de versiones..."
          
          # Buscar versiones mencionadas en la documentaciÃ³n
          echo "Versiones de UnderScript encontradas:"
          grep -rh "UnderScript.*[0-9]\+\.[0-9]\+\.[0-9]\+" docs/ README.md 2>/dev/null | head -5 || true
          
          echo "Versiones del plugin encontradas:"
          grep -rh "TournamentView.*[0-9]\+\.[0-9]\+\.[0-9]\+" docs/ README.md 2>/dev/null | head -5 || true
          
          # Verificar que el archivo principal del script (si existe) tenga versiÃ³n consistente
          if [ -f "src/tournamentview.user.js" ]; then
            SCRIPT_VERSION=$(grep -oP '@version\s+\K[0-9]+\.[0-9]+\.[0-9]+' src/tournamentview.user.js || echo "no encontrada")
            echo "VersiÃ³n en script: $SCRIPT_VERSION"
          fi
          
          echo "âœ… VerificaciÃ³n de versiones completada"

      - name: Verificar formato Markdown
        id: markdown-check
        run: |
          echo "ðŸ“ Verificando formato Markdown bÃ¡sico..."
          
          FORMAT_ISSUES=()
          
          for doc in README.md docs/*.md; do
            if [ -f "$doc" ]; then
              # Verificar que tenga tÃ­tulo H1
              if ! head -20 "$doc" | grep -q '^# '; then
                echo "âš ï¸ $doc no tiene tÃ­tulo H1 al inicio"
                FORMAT_ISSUES+=("$doc: sin tÃ­tulo H1")
              fi
              
              # Verificar que no haya lÃ­neas muy largas (>500 caracteres, excluyendo URLs)
              LONG_LINES=$(grep -n '.\{500\}' "$doc" | grep -v 'http' | wc -l)
              if [ "$LONG_LINES" -gt 0 ]; then
                echo "âš ï¸ $doc tiene $LONG_LINES lÃ­nea(s) muy larga(s)"
              fi
              
              # Verificar encoding UTF-8
              if file "$doc" | grep -qv 'UTF-8\|ASCII'; then
                echo "âš ï¸ $doc puede tener problemas de encoding"
                FORMAT_ISSUES+=("$doc: encoding incorrecto")
              fi
            fi
          done
          
          if [ ${#FORMAT_ISSUES[@]} -gt 0 ]; then
            echo "::warning::Se encontraron ${#FORMAT_ISSUES[@]} problema(s) de formato"
          else
            echo "âœ… Formato Markdown correcto"
          fi

      - name: Verificar documentaciÃ³n Fase 4
        id: fase4-docs-check
        run: |
          echo "ðŸ“š Verificando documentaciÃ³n de Fase 4 (Sistema de Plantillas)..."
          
          FASE4_ISSUES=()
          
          # Verificar que existen los documentos principales de Fase 4
          FASE4_DOCS=(
            "docs/10_FASE4_PLANTILLAS.md"
            "docs/11_FASE4_RESUMEN.md"
            "docs/16_FASE4_BUGS_RESUELTOS.md"
          )
          
          for doc in "${FASE4_DOCS[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "âŒ Falta documentaciÃ³n Fase 4: $doc"
              FASE4_ISSUES+=("Falta: $doc")
            else
              echo "âœ… Existe: $doc"
            fi
          done
          
          # Verificar que README menciona sistema de plantillas
          if grep -qi "plantilla\|template" README.md; then
            echo "âœ… README menciona sistema de plantillas"
          else
            echo "âš ï¸ README no menciona sistema de plantillas"
            FASE4_ISSUES+=("README sin referencia a plantillas")
          fi
          
          # Verificar que hay 18 bugs documentados en el archivo de bugs
          if [ -f "docs/16_FASE4_BUGS_RESUELTOS.md" ]; then
            BUG_COUNT=$(grep -c "^### Bug #" docs/16_FASE4_BUGS_RESUELTOS.md || echo "0")
            if [ "$BUG_COUNT" -ge 8 ]; then
              echo "âœ… Bugs documentados: $BUG_COUNT"
            else
              echo "âš ï¸ Solo $BUG_COUNT bugs documentados (se esperaban al menos 8)"
              FASE4_ISSUES+=("Faltan bugs en documentaciÃ³n")
            fi
          fi
          
          # Verificar que 09_LECCIONES_APRENDIDAS incluye secciÃ³n de Fase 4
          if [ -f "docs/09_LECCIONES_APRENDIDAS.md" ]; then
            if grep -q "Fase 4" docs/09_LECCIONES_APRENDIDAS.md; then
              echo "âœ… Lecciones incluyen Fase 4"
            else
              echo "âš ï¸ Lecciones no incluyen Fase 4"
              FASE4_ISSUES+=("Lecciones sin secciÃ³n Fase 4")
            fi
          fi
          
          if [ ${#FASE4_ISSUES[@]} -gt 0 ]; then
            echo "::warning::Se encontraron ${#FASE4_ISSUES[@]} problema(s) en documentaciÃ³n Fase 4"
          else
            echo "âœ… DocumentaciÃ³n Fase 4 completa"
          fi

      - name: Verificar implementaciÃ³n localStorage
        id: localstorage-check
        run: |
          echo "ðŸ’¾ Verificando persistencia localStorage..."
          
          STORAGE_ISSUES=()
          
          # Verificar que existe src/index.js
          if [ ! -f "src/index.js" ]; then
            echo "âŒ No se encuentra src/index.js"
            STORAGE_ISSUES+=("Falta src/index.js")
          else
            # Verificar que existe setActiveTemplate con localStorage.setItem
            if grep -q "localStorage\.setItem.*uc_tournament_active_template" src/index.js; then
              echo "âœ… localStorage.setItem implementado"
            else
              echo "âŒ localStorage.setItem no encontrado para plantillas"
              STORAGE_ISSUES+=("Falta localStorage.setItem")
            fi
            
            # Verificar que existe getActiveTemplateId con localStorage.getItem
            if grep -q "localStorage\.getItem.*uc_tournament_active_template" src/index.js; then
              echo "âœ… localStorage.getItem implementado"
            else
              echo "âŒ localStorage.getItem no encontrado para plantillas"
              STORAGE_ISSUES+=("Falta localStorage.getItem")
            fi
            
            # Verificar que NO se establece template default en constructor
            if grep -q "constructor.*{" src/index.js && grep -A 20 "constructor.*{" src/index.js | grep -q "setActiveTemplate.*'default'"; then
              echo "âš ï¸ Constructor podrÃ­a estar forzando template default (verificar manualmente)"
              STORAGE_ISSUES+=("Posible template default forzado")
            else
              echo "âœ… Constructor no fuerza template default"
            fi
            
            # Verificar que existe TemplateManager
            if grep -q "class TemplateManager" src/index.js; then
              echo "âœ… TemplateManager implementado"
            else
              echo "âš ï¸ TemplateManager no encontrado como clase"
            fi
          fi
          
          if [ ${#STORAGE_ISSUES[@]} -gt 0 ]; then
            echo "::error::Se encontraron ${#STORAGE_ISSUES[@]} problema(s) en implementaciÃ³n localStorage"
            exit 1
          else
            echo "âœ… Persistencia localStorage implementada correctamente"
          fi

      - name: Verificar arquitectura de plantillas
        id: template-architecture-check
        run: |
          echo "ðŸ—ï¸ Verificando arquitectura del sistema de plantillas..."
          
          ARCH_ISSUES=()
          
          if [ -f "src/index.js" ]; then
            # Verificar mÃ©todos crÃ­ticos de TemplateManager
            REQUIRED_METHODS=(
              "setActiveTemplate"
              "getActiveTemplateId"
              "loadPredefinedTemplates"
              "loadCustomTemplates"
              "exportTemplate"
              "importTemplate"
              "activateTemplate"
            )
            
            for method in "${REQUIRED_METHODS[@]}"; do
              if grep -q "$method" src/index.js; then
                echo "âœ… MÃ©todo encontrado: $method"
              else
                echo "âš ï¸ MÃ©todo no encontrado: $method"
                ARCH_ISSUES+=("Falta mÃ©todo: $method")
              fi
            done
            
            # Verificar que existen plantillas predefinidas
            if grep -q "predefinedTemplates\|this\.templates\.push" src/index.js; then
              echo "âœ… Sistema de plantillas predefinidas implementado"
            else
              echo "âš ï¸ No se encontrÃ³ sistema de plantillas predefinidas"
              ARCH_ISSUES+=("Faltan plantillas predefinidas")
            fi
          fi
          
          if [ ${#ARCH_ISSUES[@]} -gt 0 ]; then
            echo "::warning::Se encontraron ${#ARCH_ISSUES[@]} problema(s) de arquitectura"
          else
            echo "âœ… Arquitectura de plantillas correcta"
          fi

      - name: Generar resumen
        if: always()
        run: |
          echo "## ðŸ“Š Resumen del Canon Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Verificaciones Generales" >> $GITHUB_STEP_SUMMARY
          echo "| VerificaciÃ³n | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Estructura de archivos | ${{ steps.structure-check.outcome == 'success' && 'âœ… PasÃ³' || 'âŒ FallÃ³' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Enlaces internos | ${{ steps.links-check.outcome == 'success' && 'âœ… PasÃ³' || 'âŒ FallÃ³' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Ãndice README | ${{ steps.index-check.outcome == 'success' && 'âœ… PasÃ³' || 'âš ï¸ Advertencias' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| NavegaciÃ³n | ${{ steps.navigation-check.outcome == 'success' && 'âœ… PasÃ³' || 'âš ï¸ Advertencias' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Versiones | ${{ steps.version-check.outcome == 'success' && 'âœ… PasÃ³' || 'âš ï¸ Advertencias' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Formato Markdown | ${{ steps.markdown-check.outcome == 'success' && 'âœ… PasÃ³' || 'âš ï¸ Advertencias' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Verificaciones Fase 4 (Sistema de Plantillas)" >> $GITHUB_STEP_SUMMARY
          echo "| VerificaciÃ³n | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| DocumentaciÃ³n Fase 4 | ${{ steps.fase4-docs-check.outcome == 'success' && 'âœ… PasÃ³' || 'âš ï¸ Advertencias' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Persistencia localStorage | ${{ steps.localstorage-check.outcome == 'success' && 'âœ… PasÃ³' || 'âŒ FallÃ³' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Arquitectura de plantillas | ${{ steps.template-architecture-check.outcome == 'success' && 'âœ… PasÃ³' || 'âš ï¸ Advertencias' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Ejecutado: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY
