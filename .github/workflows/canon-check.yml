# Canon Consistency Check
# Verifica que la documentaciÃ³n del proyecto sea consistente

name: Canon Consistency Check

on:
  push:
    branches: [main, master]
    paths:
      - 'docs/**'
      - 'README.md'
      - 'src/**'
  pull_request:
    branches: [main, master]
    paths:
      - 'docs/**'
      - 'README.md'
      - 'src/**'
  workflow_dispatch:

jobs:
  canon-check:
    name: Verificar Consistencia
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v4

      - name: Verificar estructura de documentaciÃ³n
        id: structure-check
        run: |
          echo "ðŸ“ Verificando estructura de archivos..."
          
          REQUIRED_FILES=(
            "README.md"
            "docs/README.md"
            "docs/README_ES.md"
            "docs/API.md"
            "docs/DEVELOPMENT.md"
            "docs/TEMPLATE_GUIDE.md"
            "docs/TESTING_GUIDE.md"
          )
          
          MISSING_FILES=()
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              MISSING_FILES+=("$file")
              echo "âŒ Falta: $file"
            else
              echo "âœ… Existe: $file"
            fi
          done
          
          if [ ${#MISSING_FILES[@]} -gt 0 ]; then
            echo "::error::Faltan ${#MISSING_FILES[@]} archivo(s) de documentaciÃ³n requeridos"
            exit 1
          fi
          
          echo "âœ… Todos los archivos de documentaciÃ³n existen"

      - name: Verificar enlaces internos
        id: links-check
        run: |
          echo "ðŸ”— Verificando enlaces internos..."
          
          BROKEN_LINKS=()
          
          check_links() {
            local file=$1
            echo "Analizando: $file"
            
            links=$(grep -oP '\[.*?\]\(\K[^)]+(?=\))' "$file" 2>/dev/null | grep -v '^http' | grep -v '^#' || true)
            
            for link in $links; do
              clean_link=$(echo "$link" | sed 's/#.*//')
              
              if [ -n "$clean_link" ]; then
                dir=$(dirname "$file")
                target="$dir/$clean_link"
                target=$(realpath -m "$target" 2>/dev/null || echo "$target")
                
                if [ ! -f "$target" ]; then
                  echo "âŒ Enlace roto en $file: $link"
                  BROKEN_LINKS+=("$file: $link")
                fi
              fi
            done
          }
          
          check_links "README.md"
          
          for doc in docs/*.md; do
            if [ -f "$doc" ]; then
              check_links "$doc"
            fi
          done
          
          if [ ${#BROKEN_LINKS[@]} -gt 0 ]; then
            echo "::error::Se encontraron ${#BROKEN_LINKS[@]} enlace(s) roto(s)"
            exit 1
          fi
          
          echo "âœ… Todos los enlaces internos son vÃ¡lidos"

      - name: Verificar formato Markdown
        id: markdown-check
        run: |
          echo "ðŸ“ Verificando formato Markdown..."
          
          FORMAT_ISSUES=()
          
          for doc in README.md docs/*.md; do
            if [ -f "$doc" ]; then
              if ! head -20 "$doc" | grep -q '^# '; then
                echo "âš ï¸ $doc no tiene tÃ­tulo H1 al inicio"
                FORMAT_ISSUES+=("$doc: sin tÃ­tulo H1")
              fi
              
              if file "$doc" | grep -qv 'UTF-8\|ASCII'; then
                echo "âš ï¸ $doc puede tener problemas de encoding"
                FORMAT_ISSUES+=("$doc: encoding incorrecto")
              fi
            fi
          done
          
          if [ ${#FORMAT_ISSUES[@]} -gt 0 ]; then
            echo "::warning::Se encontraron ${#FORMAT_ISSUES[@]} problema(s) de formato"
          else
            echo "âœ… Formato Markdown correcto"
          fi

      - name: Verificar cÃ³digo fuente
        id: source-check
        run: |
          echo "ðŸ’¾ Verificando cÃ³digo fuente..."
          
          if [ ! -f "src/index.js" ]; then
            echo "âŒ No se encuentra src/index.js"
            exit 1
          fi
          
          # Verificar localStorage
          if grep -q "localStorage" src/index.js; then
            echo "âœ… localStorage implementado"
          else
            echo "âš ï¸ localStorage no encontrado"
          fi
          
          # Verificar TemplateManager
          if grep -q "TemplateManager\|templateManager" src/index.js; then
            echo "âœ… TemplateManager implementado"
          else
            echo "âš ï¸ TemplateManager no encontrado"
          fi
          
          echo "âœ… VerificaciÃ³n de cÃ³digo completada"

      - name: Generar resumen
        if: always()
        run: |
          echo "## ðŸ“Š Canon Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| File Structure | ${{ steps.structure-check.outcome == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Internal Links | ${{ steps.links-check.outcome == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Markdown Format | ${{ steps.markdown-check.outcome == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Source Code | ${{ steps.source-check.outcome == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Run: $(date -u '+%Y-%m-%d %H:%M UTC')*" >> $GITHUB_STEP_SUMMARY
